# Continuos Integration workflow

name: CI

defaults:
  run:
    shell: bash -ieo pipefail {0}

# Controls when the workflow will run
on:
  # Main push
  push:
    branches: ['main']
    paths-ignore:
      - README.md
      - CHANGELOG.md
      - LICENSE
      - .github/workflows/release.yml
      - .github/workflows/assets-auto-update.yml
      
  # Any pull request update
  pull_request:
    branches: ['main']
    paths-ignore:
      - README.md
      - CHANGELOG.md
      - LICENSE
      - .github/workflows/release.yml
      - .github/workflows/assets-auto-update.yml

  # Can be triggered by other workflows
  workflow_call:
    inputs:
      skip_crawler_test:
        type: boolean
        description: 'Whether the crawler test should run'
        required: true
        default: false

  # Allow manual trigger
  workflow_dispatch:

# Jobs
jobs:

  dividends:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code ğŸ“¥
        uses: actions/checkout@v3

      - name: NodeJS setup ğŸ› ï¸
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies ğŸ”§
        run:  npm ci
      
      - name: Run test ğŸ§ª
        run:  npm run test dividends

  rico-compliance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code ğŸ“¥
        uses: actions/checkout@v3

      - name: NodeJS setup ğŸ› ï¸
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies ğŸ”§
        run:  npm ci
      
      - name: Run test ğŸ§ª
        run:  npm run test rico

  clear-compliance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code ğŸ“¥
        uses: actions/checkout@v3

      - name: NodeJS setup ğŸ› ï¸
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies ğŸ”§
        run:  npm ci
      
      - name: Run test ğŸ§ª
        run:  npm run test rico

  crawler:
    # Skip check if this CI was triggered by another workflow
    if: ${{ ! inputs.skip_crawler_test }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code ğŸ“¥
        uses: actions/checkout@v3

      - name: NodeJS setup ğŸ› ï¸
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies ğŸ”§
        run:  npm ci
      
      - name: Run test ğŸ§ª
        run:  npm run test crawler

  webpack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code ğŸ“¥
        uses: actions/checkout@v3

      - name: NodeJS setup ğŸ› ï¸
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies and build ğŸ”§
        run: npm ci && npm run build && npm run pack
      
      - name: Run test ğŸ§ª
        run:  npm run test webpack

  # Trigger the release if a version tag was submitted
  make_release:
    needs: [ dividends, rico-compliance, clear-compliance, crawler, webpack ]
    if: contains(github.event.ref, 'refs/tags/v')
    uses: ./.github/workflows/release.yml
    secrets: inherit
    with:
      release_version: ${{ github.ref_name }}

# EOF
