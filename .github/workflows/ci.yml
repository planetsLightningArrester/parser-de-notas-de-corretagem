# Continuos Integration workflow
name: ðŸ”„ CI

defaults:
  run:
    shell: bash -ieo pipefail {0}

# Controls when the workflow will run
on:
  # Main push
  push:
    branches: ['main']
    paths-ignore:
      - README.md
      - CHANGELOG.md
      - LICENSE
      - .github/workflows/release.yml
      - .github/workflows/assets-auto-update.yml
      
  # Any pull request update
  pull_request:
    branches: ['main']
    paths-ignore:
      - README.md
      - CHANGELOG.md
      - LICENSE
      - .github/workflows/release.yml
      - .github/workflows/assets-auto-update.yml

  # Can be triggered by other workflows
  workflow_call:
    inputs:
      skip_crawler_test:
        type: boolean
        description: 'Whether the crawler test should run'
        required: true
        default: false

  # Allow manual trigger
  workflow_dispatch:

# Jobs
jobs:

  dividends:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ðŸ› ï¸ NodeJS setup
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: ðŸ”§ Install dependencies
        run:  npm ci
      
      - name: ðŸ§ª Run test
        run:  npm run test dividends

  rico-compliance:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ðŸ› ï¸ NodeJS setup
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: ðŸ”§ Install dependencies
        run:  npm ci
      
      - name: ðŸ§ª Run test
        run:  npm run test rico

  clear-compliance:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ðŸ› ï¸ NodeJS setup
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: ðŸ”§ Install dependencies
        run:  npm ci
      
      - name: ðŸ§ª Run test
        run:  npm run test rico

  crawler:
    # Skip check if this CI was triggered by another workflow
    if: ${{ ! inputs.skip_crawler_test }}
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ðŸ› ï¸ NodeJS setup
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: ðŸ”§ Install dependencies
        run:  npm ci
      
      - name: ðŸ§ª Run test
        run:  npm run test crawler

  webpack:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ðŸ› ï¸ NodeJS setup
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies and build ðŸ”§
        run: npm ci && npm run build && npm run pack
      
      - name: ðŸ§ª Run test
        run:  npm run test webpack

  check_if_release_is_required:
    name: Check if release is required 
    runs-on: ubuntu-latest
    needs: [ dividends, rico-compliance, clear-compliance, crawler, webpack ]
    # Skip check if this CI was triggered by another workflow
    if: ${{ ! inputs.skip_crawler_test }}
    outputs:
      RELEASE_VERSION: ${{ steps.result.outputs.RELEASE_VERSION }}
    steps:
      - name: Check if a new release has to be created
        id: result
        shell: bash
        run: |
          last_commit_message="${{ github.event.head_commit.message }}"
          if [[ -n "$last_commit_message" ]] && [[ "$last_commit_message" =~ v[[:digit:]]+\.[[:digit:]]+\.[[:digit:]]+ ]]; then
            echo "RELEASE_VERSION=$last_commit_message" >> $GITHUB_OUTPUT;
          fi

  # Trigger the release if a version tag was submitted
  make_release:
    needs: check_if_release_is_required
    if: ${{ needs.check_if_release_is_required.outputs.RELEASE_VERSION }}
    uses: ./.github/workflows/release.yml
    secrets: inherit
    with:
      release_version: ${{ needs.check_if_release_is_required.outputs.RELEASE_VERSION }}

# EOF
